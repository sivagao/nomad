{"data":{"mongodbDatabaseArticles":{"id":"5b93833a87be056953db7e3f","content":"<div><h1 name=\"127f\" id=\"127f\" class=\"graf graf--h3 graf--leading graf--title\">RDP hijacking&#8202;&#8212;&#8202;how to hijack RDS and RemoteApp sessions transparently to move through an organisation</h1><h2 name=\"f58f\" id=\"f58f\" class=\"graf graf--h4 graf-after--h3 graf--subtitle\">How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software&#8202;&#8212;&#8202;and how to defend against&#160;it.</h2><p class=\"aspectRatioPlaceholder-fill\"></p><img class=\"graf-image\" src=\"https://cdn-images-1.medium.com/max/1600/1*bd6ZhReKUzjJwunNpA6cDg.gif\">Alexander Korznikov demonstrates using Sticky Keys and tscon to access an administrator RDP session&#8202;&#8212;&#8202;without even logging into the&#160;server.<h4 name=\"a625\" id=\"a625\" class=\"graf graf--h4 graf-after--figure\">Brief background on RDP session connection</h4><p name=\"9669\" id=\"9669\" class=\"graf graf--p graf-after--h4\">If you&#8217;ve used Remote Desktop Services before, or Terminal Services if you&#8217;re as old as me, you will know there&#8217;s a feature where you connect to another user&#8217;s session&#8202;&#8212;&#8202;if you know their password. Did you know you can also hijack a session without the user password? Read on.</p><p name=\"c10c\" id=\"c10c\" class=\"graf graf--p graf-after--p\">You can right click a user in Task Manager, use tsadmin.msc, or use the command tscon.exe. It will ask for a password, and bomb if you can&#8217;t authenticate as the user:</p><p class=\"aspectRatioPlaceholder-fill\"></p><img class=\"graf-image\" src=\"https://cdn-images-1.medium.com/max/1600/1*Wr_SRDwI4hYKClcVKc0rrQ.png\"><h4 name=\"a086\" id=\"a086\" class=\"graf graf--h4 graf-after--figure\">Some tricks allow credential-less Session Hijacking</h4><p name=\"e7b4\" id=\"e7b4\" class=\"graf graf--p graf-after--h4\">Here&#8217;s the deal. As revealed by by <a href=\"http://blog.gentilkiwi.com/securite/vol-de-session-rdp\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">Benjamin Delpy</a> (of Mimikatz) in 2011 and by <a href=\"http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">Alexander Korznikov</a> on Friday, if you run tscon.exe as the SYSTEM user, <strong class=\"markup--strong markup--p-strong\">you can connect to any session without a password</strong>. It doesn&#8217;t prompt, it just connects you to the user&#8217;s desktop. I believe this is due to the way session shadowing was implemented in Microsoft Windows, and it runs throughout the years like this.</p><p name=\"576b\" id=\"576b\" class=\"graf graf--p graf-after--p\">Now, you might be saying &#8216;If you&#8217;re SYSTEM, you&#8217;re already root&#8230; You can already do anything&#8217;.</p><p name=\"b0e3\" id=\"b0e3\" class=\"graf graf--p graf-after--p\">Yes. Yes you can. You could, for example, dump out the server memory and get user passwords. That&#8217;s a long process compared to just running tscon.exe with a session number, and instantly get the desktop of said user&#8202;&#8212;&#8202;with no obvious trace, or external tools. This isn&#8217;t about SYSTEM&#8202;&#8212;&#8202;this is about what you can do with it very quickly, and quietly. Attackers aren&#8217;t interested in playing, they&#8217;re interested in what they can do with techniques. This is a very valid technique.</p><p name=\"322b\" id=\"322b\" class=\"graf graf--p graf-after--p\">So, you have full blown RDP session hijacking, with a single command.</p><h4 name=\"6400\" id=\"6400\" class=\"graf graf--h4 graf-after--p\">Some parameters about how far this&#160;reaches</h4><ul class=\"postList\"><li name=\"a30f\" id=\"a30f\" class=\"graf graf--li graf-after--h4\">You can connect to disconnected sessions. So if somebody logged out 3 days ago, you can just connect straight to their session and start using it.</li><li name=\"167a\" id=\"167a\" class=\"graf graf--li graf-after--li\">It unlocks locked sessions. So if a user is away from their desk, you steal their session AND it unlocks the &#8216;workstation&#8217; without needing any credentials.</li><li name=\"0193\" id=\"0193\" class=\"graf graf--li graf-after--li\">It works for the physical console. So you can hijack the screen remotely. It also unlocks the physical console, too.</li><li name=\"99f5\" id=\"99f5\" class=\"graf graf--li graf-after--li\">You can connect to ANY session&#8202;&#8212;&#8202;so if, for example, it&#8217;s the Helpdesk, you can connect to it without any authentication. If it&#8217;s a Domain Admin, you&#8217;re in. Because of the above point (you can connect to disconnected sessions), this makes it an incredibly simple way to laterally move through a network.</li><li name=\"2544\" id=\"2544\" class=\"graf graf--li graf-after--li\">You can use win32k <a href=\"https://arstechnica.co.uk/security/2016/11/trick-or-treat-google-issues-warning-of-critical-windows-vulnerability/\" class=\"markup--anchor markup--li-anchor\" rel=\"nofollow noopener\" target=\"_blank\">SYSTEM exploits</a>&#8202;&#8212;&#8202;there are many&#8202;&#8212;&#8202;to gain SYSTEM permissions, and then use this feature. Meaning even as a standard user, if patches aren&#8217;t applied properly you can use this. Obviously, any route to SYSTEM is valid&#8202;&#8212;&#8202;e.g. any method to get to a local administrator (there&#8217;s a few!).</li><li name=\"f4df\" id=\"f4df\" class=\"graf graf--li graf-after--li\">There are no external tools. Nothing to get through application whitelisting. No executable is written to disk.</li><li name=\"faf2\" id=\"faf2\" class=\"graf graf--li graf-after--li\">Unless you know what to monitor (more on that later), you won&#8217;t know this is happening.</li><li name=\"fb14\" id=\"fb14\" class=\"graf graf--li graf-after--li\">It works remotely. You can take over sessions on remote computers, even if you&#8217;re not logged into that server.</li></ul><h4 name=\"e8fa\" id=\"e8fa\" class=\"graf graf--h4 graf-after--li\">Gaining SYSTEM for tscon.exe</h4><p name=\"7edc\" id=\"7edc\" class=\"graf graf--p graf-after--h4\">If you&#8217;re an administrator, you can use a service as Alexander demonstrates:</p><p class=\"aspectRatioPlaceholder-fill\"></p><img class=\"graf-image\" src=\"https://cdn-images-1.medium.com/max/1600/1*S5y5lGUCtZXvGQi7IpHpew.png\"><p name=\"4dc7\" id=\"4dc7\" class=\"graf graf--p graf-after--figure\">In essence it is really easy, just use the quser command to get the Session ID you want to hijack, and your own SESSIONNAME. Then run tscon with the Session ID for hijack, and your own SESSIONNAME. Your own Session will be replaced with the hijacked session. The service will run as SYSTEM by default&#8202;&#8212;&#8202;you&#8217;re in.</p><p name=\"f815\" id=\"f815\" class=\"graf graf--p graf-after--p\">Just remember to delete the service afterwards, if you&#8217;re evil.</p><p name=\"206e\" id=\"206e\" class=\"graf graf--p graf-after--p\">Here&#8217;s an example of it in practice on a Windows Server 2012 R2 server:</p><p name=\"dd57\" id=\"dd57\" class=\"graf graf--p graf-after--p\"><a href=\"https://www.youtube.com/watch?v=OgsoIoWmhWw\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">https://www.youtube.com/watch?v=OgsoIoWmhWw</a></p><p name=\"34ea\" id=\"34ea\" class=\"graf graf--p graf-after--p\">Other methods:</p><ul class=\"postList\"><li name=\"fa55\" id=\"fa55\" class=\"graf graf--li graf-after--p\">You can use Scheduled Tasks to gain SYSTEM and run the command. Just schedule the command to run immediately as SYSTEM with interactive privileges.</li><li name=\"e0fb\" id=\"e0fb\" class=\"graf graf--li graf-after--li\">Use can use a variety of methods like Sticky Keys to get SYSTEM, without even needing to log in (in the future). See below.</li><li name=\"00cc\" id=\"00cc\" class=\"graf graf--li graf-after--li\">Exploits etc (see above).</li></ul><h4 name=\"1dfb\" id=\"1dfb\" class=\"graf graf--h4 graf-after--li\">Lateral movement</h4><p name=\"6555\" id=\"6555\" class=\"graf graf--p graf-after--h4\">Most organisations allow Remote Desktop through their internal network, because it&#8217;s 2017 and that&#8217;s how Windows administration works. Also, RemoteApp uses RDP. Because of this, it&#8217;s a fantastic way to move around an organisation&#8217;s network&#8202;&#8212;&#8202;forget passwords, just surf around and abuse other people&#8217;s access. You appear in the organisation logs as that user, not yourself.</p><h4 name=\"875d\" id=\"875d\" class=\"graf graf--h4 graf-after--p\">How to backdoor for credential-less hijacking</h4><p name=\"652e\" id=\"652e\" class=\"graf graf--p graf-after--h4\">Remote Desktop bruteforcing is a major problem. Anybody who has setup a honeypot recently will know within seconds you will be getting hit with failed RDP logins. First they portscan, then thousands of login attempts arrive.</p><p name=\"ea52\" id=\"ea52\" class=\"graf graf--p graf-after--p\">It gets worse&#8202;&#8212;&#8202;I run RDP honeypots, and I see them regularly&#8202;&#8212;&#8202;when breached they get backdoored using the techniques below.</p><p name=\"3547\" id=\"3547\" class=\"graf graf--p graf-after--p\">From research, over 1 in 200 scanned Remote Desktop servers online are already backdoored using these methods. This means that you can session hijack with them right now, without even needing to try to log in or authenticate in any way. That&#8217;s bad. Consider Shodan shows there are millions of RDP servers online right now, and the number grows constantly with cloud services etc, this is going to generate&#8230; issues.</p><h4 name=\"b6c3\" id=\"b6c3\" class=\"graf graf--h4 graf-after--p\">RDP backdoor method one&#8202;&#8212;&#8202;Sticky&#160;Keys</h4><p name=\"c755\" id=\"c755\" class=\"graf graf--p graf-after--h4\">The concept here is pretty simple&#8202;&#8212;&#8202;Windows supports a feature called Sticky Keys, which is an Accessibility feature built into the OS and available pre-logon (at the login screen, either via a physical console or via Remote Desktop). It runs as SYSTEM.</p><p name=\"57df\" id=\"57df\" class=\"graf graf--p graf-after--p\">If you set Sethc.exe (Sticky Keys) to spawn cmd.exe, you have a backdoor you can use if you are locked out of a box&#8202;&#8212;&#8202;you have SYSTEM access, so you can do anything even without an account. You can do this by either replacing sethc.exe with cmd.exe&#8202;&#8212;&#8202;this requires a reboot, and physical access to the box&#8202;&#8212;&#8202;or just set the registry key using the command below.</p><pre name=\"139b\" id=\"139b\" class=\"graf graf--pre graf-after--p\">REG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe\" /t REG_SZ /v Debugger /d &#8220;C:\\windows\\system32\\cmd.exe&#8221; /f</pre><p name=\"e4ab\" id=\"e4ab\" class=\"graf graf--p graf-after--pre\">Ta-da! The box is now permanently backdoored. Just Remote Desktop in and at the login screen, hit F5 a bunch of times.</p><h4 name=\"d16d\" id=\"d16d\" class=\"graf graf--h4 graf-after--p\">Method two&#8202;&#8212;&#8202;Utilman</h4><p name=\"06e4\" id=\"06e4\" class=\"graf graf--p graf-after--h4\">It&#8217;s exactly the same as before, just trojan utilman.exe instead. At the login screen, press Windows Key+U, and you get a cmd.exe window as SYSTEM.</p><pre name=\"7442\" id=\"7442\" class=\"graf graf--pre graf-after--p\">REG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\utilman.exe\" /t REG_SZ /v Debugger /d &#8220;C:\\windows\\system32\\cmd.exe&#8221; /f</pre><h4 name=\"c067\" id=\"c067\" class=\"graf graf--h4 graf-after--pre\">Scanning for backdoor&#8217;d RDP&#160;servers</h4><p name=\"cc64\" id=\"cc64\" class=\"graf graf--p graf-after--h4\">There is a prebuilt tool here, which works wonders&#8202;&#8212;&#8202;just spin it up and find servers which already have a SYSTEM level backdoor exposed:</p><p name=\"ff6c\" id=\"ff6c\" class=\"graf graf--p graf-after--mixtapeEmbed\">From online scanning, a significant amount of open RDP servers online are already backdoored.</p><h4 name=\"a5b4\" id=\"a5b4\" class=\"graf graf--h4 graf-after--p\">Mimikatz module</h4><p name=\"aeeb\" id=\"aeeb\" class=\"graf graf--p graf-after--h4\">There is now a Mimikatz module for very easily doing this:</p><p class=\"aspectRatioPlaceholder-fill\"></p><img class=\"graf-image\" src=\"https://cdn-images-1.medium.com/max/1600/1*oFF3A3KhTzGrEnS_3vV36g.gif\">gentilkiwi rocking&#160;it<h4 name=\"db3c\" id=\"db3c\" class=\"graf graf--h4 graf-after--figure\">Mitigations</h4><p name=\"e444\" id=\"e444\" class=\"graf graf--p graf-after--h4\"><strong class=\"markup--strong markup--p-strong\">OS</strong>-I had a section about Window Server 2016 here, however after further investigation it appears to also be impacted. After testing this applies to every OS since Windows 2000, including Windows 10 and 2016.</p><p name=\"6ea7\" id=\"6ea7\" class=\"graf graf--p graf-after--p\"><strong class=\"markup--strong markup--p-strong\">Group Policy&#8202;</strong>&#8212;&#8202;I strongly recommend you use Group Policy to log off disconnected sessions, either immediately or soon after the user disconnects. This will NOT be popular in IT environments&#8202;&#8212;&#8202;but the risk is now completely real that they can very easily&#8202;&#8212;&#8202;with one built in command&#8202;&#8212;&#8202;be hijacked more or less silently in the real world. I would also log off idle sessions.</p><p name=\"ec3c\" id=\"ec3c\" class=\"graf graf--p graf-after--p\"><strong class=\"markup--strong markup--p-strong\">Don&#8217;t expose RDS/RDP to the internet&#8202;</strong>&#8212;&#8202;if you do, I <strong class=\"markup--strong markup--p-strong\">strongly suggest </strong>you implement multi-factor authentication. You can use things like Microsoft RD Gateway or Azure Multi-Factor Authentication Server to get very low cost multi-factor authentication. If you&#8217;re exposing RDP directly to the internet and somebody creates a local user or your domain users have easy to guess or reused credentials, things will go downhill fast. Trust me&#8202;&#8212;&#8202;I&#8217;ve seen hospitals and others be ransomware&#8217;d by RDS servers.</p><h4 name=\"1479\" id=\"1479\" class=\"graf graf--h4 graf-after--p\">Monitoring</h4><p name=\"c6da\" id=\"c6da\" class=\"graf graf--p graf-after--h4\">It is surprisingly very difficult to record session hijacking&#8202;&#8212;&#8202;there is one event log (Microsoft-Windows-TerminalServices-LocalSessionManager/Operational) which records sessions connecting&#8202;&#8212;&#8202;however it does not appear to differentiate between a normal user connecting and tscon.exe being used&#8202;&#8212;&#8202;I&#8217;ve been through every other event log and can&#8217;t see anything which suggests this is happening. This is actually a major issue and I lobby Microsoft to add some kind of Event Log ASAP&#8202;&#8212;&#8202;it&#8217;s a real gap.</p><p name=\"495e\" id=\"495e\" class=\"graf graf--p graf-after--p\">My suggestion is you alert for other related behaviour using the Event Log and tools like Microsoft OMS, Windows Event Forwarding, Splunk etc. You&#8217;re looking for SYSTEM being misused.</p><p name=\"f98b\" id=\"f98b\" class=\"graf graf--p graf-after--p\">For example abnormal Service creation and abnormal scheduled task creation should be logged centrally, and recorded against. Additionally, you can look for Mimikatz related activity.</p><ul class=\"postList\"><li name=\"78e4\" id=\"78e4\" class=\"graf graf--li graf-after--p\">k</li></ul><h4 name=\"5fd2\" id=\"5fd2\" class=\"graf graf--h4 graf-after--li\">FAQ</h4><p name=\"6aca\" id=\"6aca\" class=\"graf graf--p graf-after--h4\">Q: This isn&#8217;t new or a vulnerability.</p><p name=\"7825\" id=\"7825\" class=\"graf graf--p graf-after--p\">A: Java applets and macros aren&#8217;t new. If the technique works, it will get used. This one has flown under the radar&#8202;&#8212;&#8202;that doesn&#8217;t mean it is not valid.</p><p name=\"9a4f\" id=\"9a4f\" class=\"graf graf--p graf-after--p\">Q: If you have SYSTEM you already own the box.</p><p name=\"e25f\" id=\"e25f\" class=\"graf graf--p graf-after--p graf--trailing\">A: Correct. Can you type one command and get the unlocked desktop of a user, even if they went on holiday a week ago, without a log of it? Now you can.</p></div>","title":"RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…"}},"pageContext":{"id":"5b93833a87be056953db7e3f"}}